<!--%-- 
    Document   : viewer
    Created on : Jan 7, 2014, 2:13:44 AM
    Author     : Mershack
--%>

<%@page contentType="text/html" pageEncoding="UTF-8"% -->
<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>The Viewer</title>

        <link href="Styles.css" rel="stylesheet" type="text/css" />
        <script src="jQuery/jquery-1.10.2.js"></script>
        <script src="http://code.jquery.com/jquery-latest.min.js"></script>
        <script type="text/javascript" src="jscolor/jscolor.js"></script>
        <!--      <script type="text/javascript" src="proplist.js"></script> -->

        <!--script and style for jquery slider and spinner -->
        <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
        <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
        <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>




        <script type="text/javascript" src="ajax.js"></script>
        <script type="text/javascript" src="image-transferer.js"></script>
        <script type="text/javascript" src="property-manager.js"></script> 


        <script type="text/javascript">


            var xMargin = 300;
            var yMargin = 10;

            var ims = [];

            var dragFlag = 0;
            var randLength = 6;
            var randStr = "";
            var theUrl = "";
            var cnt = 0;
            var prop_cnt = 0;

            var mousePos,
                    posDisplay = document.getElementById("posDisplay");
            // counterDisplay = document.getElementById("counterDisplay"),
            // counter = 0;

            var mouseType = "left";

            var prevx = 0;
            var prevy = 0;
            var prevtime = 0;
            var starttime = (new Date()).getTime();
            var rendercnt = 0;
            var prevtimerender = starttime;

            var cttt = 0;
            var ttt = 0;
            var loading = 0;


            var inmousemove = false;

            var ts = 0;
            var inpollprops = false;
            var xmlhttp;

            function initialize() {
                // alert("The name of the viewer is " +document.getElementById("viewerName").value);
                makeRequest('properties');

                document.getElementById("canv").onmousedown = handleMouseDown; //to handle mouse-clicks
                document.getElementById("canv").onmouseup = handleMouseUp;
                document.getElementById("canv").onmousemove = handleMouseMove;


                var imageTransf = new ImageTransferer(document.getElementById("canv"), 1000, 700, 2, 2);
                setInterval(function() {
                    imageTransf.imageUpdate()
                }, 50);

                setInterval(pollprops, 500);

                window.oncontextmenu = handleContextMenu;

            }

            function pollprops()
            {
                //TO-DO:REMEMBER TO MAKE THE inpollprops false after handling the properties
                if (inpollprops)
                    return;
                inpollprops = true;

                cnt++;
                xmlhttp = new XMLHttpRequest();
                xmlhttp.onreadystatechange = function()
                {
                    
                   if (xmlhttp.readyState === 4 && xmlhttp.status === 200)
                    {
                    
                        if (xmlhttp.responseText.length !== 0)
                        {

                           var viewerProperties = document.getElementById("properties");

                          document.getElementById("pollprops").value="true";
                         addProperties(viewerProperties, xmlhttp.responseText);


                        }
                         document.getElementById("pollprops").value="false";
                        inpollprops = false;
                    }
                };

                var viewerName = document.getElementById("viewerName").value;
                
                xmlhttp.open("GET", "VizOnlineServlet?page=pollprops&factoryItemName="+viewerName+"&r=" + cnt, true);
                xmlhttp.send();
            }


            function sendCommand(url) {
                xmlhttp = new XMLHttpRequest();
                console.log(url);
                xmlhttp.open("GET", url, true);
                xmlhttp.send();
            }


            function handleMouseUp(event) {

                cnt++;

                event = event || window.event; // IE-ism

                event.preventDefault();

                mousePos = {
                    x: event.clientX + document.body.scrollLeft - xMargin,
                    y: event.clientY + document.body.scrollTop - yMargin
                };


                //check if mousedrag or mouse click
                var elem = event.target;

                if ((mousePos.x - xMargin) > 1000)
                    return true;


                dragFlag = 0;


                if (event.which === 3) {
                    mouseType = "right";
                }
                else {
                    mouseType = "left ";
                }


                var viewerName = document.getElementById("viewerName").value;
                // alert(viewerName);

                theUrl = 'VizOnlineServlet?page=viewer&mousetype=' + mouseType + '&cmd=mouseUp&mx='
                        + mousePos.x + '&my=' + mousePos.y + "&viewerName=" + viewerName + "&r=" + cnt;
                sendCommand(theUrl);

            }


            function handleContextMenu(event) {
                event = event || window.event; // IE-ism                  
                var elem = event.target;
                if (elem.parentNode.id === "canv") { //avoid right-click menu on the canv
                    return false;
                }
            }

            function handleMouseDown(event) {

                cnt++;
                event = event || window.event; // IE-ism                  
                var elem = event.target;


                mousePos = {
                    x: event.clientX + document.body.scrollLeft - xMargin,
                    y: event.clientY + document.body.scrollTop - yMargin
                };
                //  alert(mousePos.x  + " " + mousePos.y);  

                if ((mousePos.x) >= 1000 || mousePos.y >= 800)
                {
                    return true;
                }



                if (event.target.id == "button1")
                {
                    window.clearInterval(interval);
                    alert(parseInt(document.getElementById("refresh").value));
                    interval = setInterval(clientImageUpdate, parseInt(document.getElementById("refresh").value));
                }
                else if (event.target.id == "button2")
                {

                    var viewerName = document.getElementById("viewerName").value;
                    theUrl = 'VizOnlineServlet?changeEncoding=' + document.getElementById("encoding").value
                            +"&viewerName="+viewerName+"&r=" + cnt;
                    //alert(theUrl);  
                    sendCommand(theUrl);
                    return true;
                }

                dragFlag = 1;









                if (event.which === 3) {
                    mouseType = "right";
                }
                else {
                    mouseType = "left ";
                }

                var viewerName = document.getElementById("viewerName").value;
                theUrl = 'VizOnlineServlet?page=viewer&mousetype=' + mouseType + '&cmd=mouseDown&mx=' + mousePos.x
                        + '&my=' + mousePos.y + "&viewerName="+viewerName + "&r=" + cnt;

                sendCommand(theUrl);



                return false; //this is to prevent image dragging.
            }




            function handleMouseMove(event) {

                if (inmousemove)
                    return;
                inmousemove = true;

                cnt++;
                event = event || window.event; // IE-ism
                var elem = event.target;


                mousePos = {
                    x: event.clientX - xMargin,
                    y: event.clientY - yMargin
                };

                document.getElementById("fps2").innerHTML = mousePos.x + " " + mousePos.y;
                document.getElementById("fps").innerHTML = document.body.scrollLeft + " " + document.body.scrollTop;

                if ((mousePos.x) >= 1000 || mousePos.y >= 800)
                {
                    return true;
                }

                if (((new Date()).getTime() - prevtime < 50))
                {
                    inmousemove = false;
                    return;
                }
                prevx = mousePos.x;
                prevy = mousePos.y;
                prevtime = (new Date()).getTime();


                if (event.which === 3) {
                    mouseType = "right";
                }
                else {
                    mouseType = "left ";
                }

                if (dragFlag === 1) {//mouse is being dragged
                    
                    var viewerName = document.getElementById("viewerName").value;
                    theUrl = 'VizOnlineServlet?page=viewer&mousetype=' + mouseType + '&cmd=mouseDragged&mx='
                            + mousePos.x + '&my=' + mousePos.y + "&viewerName="+viewerName + "&r=" + cnt;
                    sendCommand(theUrl);
                }
                else { //normal mouse move
                    var viewerName = document.getElementById("viewerName").value;
                    theUrl = 'VizOnlineServlet?page=viewer&mousetype=' + mouseType + '&cmd=mouseMoved&mx='
                            + mousePos.x + '&my=' + mousePos.y + "&viewerName="+viewerName + "&r=" + cnt;
                    sendCommand(theUrl);
                }
                inmousemove = false;
            }

            function getMousePosition() {
                var pos = mousePos;
                if (!pos) {
                    // We haven't seen any movement yet
                    pos = {x: "?", y: "?"};
                }
                posDisplay.innerHTML = "(" + pos.x + "," + pos.y + ")";

                //  counterDisplay.innerHTML = ++counter;

            }

            function addProperty(name, type, value)
            {

            }

            // };

        </script>


    </head>

    <body onload="initialize();">
        <div id="generalHolder">

            <div class ="container"> 

                <div class="leftVdiv" >

                    <div id="fps" style="left:0px;">frame/sec</div>
                    <div id="fps2" style="left:0px;">frame/sec</div> <br>
                    <div id="controls" style="left:0;">
                        <input type="text" id="refresh" /><button id = "button1" onclick="alert('fff');"></button><br>
                        <input type="text" id="encoding" /><button  id="button2"></button><br>
                        <input type="text" id="loading" /><br>

                        <div id="propslot" style="position: absolute;"></div>
                    </div>


                    <div id='sent'></div>
                    <h1>Viewer Properties</h1>
                    <form>

                        <!--   <input type ="button" class="small button blue" value="Show Properties"
                                         onclick="makeRequest('properties')"/>  -->    
                        <div  id='properties' > 
                            <!-- end innerleftdiv --> </div>              
                    </form> 
                    <!-- end .leftdiv -->    
                </div>   



                <!-- IMAGE DIV -->

                <div id='output'  class="rightVdiv">
                    <div id="canv" style="width:800pt; height:450pt;"></div>                
                </div>

                <!--  -->

                <input type="hidden" id="factoryType" value="Viewer" />
                <input type ="hidden" id="factoryItemName" value="" />
                <input type="hidden" id="viewerName" value="" />
                 <input type ="hidden" id="pollprops" value="false" />

            </div>



        </div>


    </body>

</html>
